@model MiniJira.MVC.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<div class="container-fluid mt-4">

    <!-- Header (keeps your original look but centered nicely) -->
    <div class="d-flex align-items-center mb-4">
        <img src="~/Images/PB1.jpg" alt="MiniJira"
             style="height:48px;margin-right:12px;border-radius:50%;
            box-shadow:0 0 4px rgba(0,0,0,0.25);" />



        <h2 class="m-0 fw-semibold">PB - Dashboard</h2>

        <div class="ms-auto d-flex gap-2">
            <a class="btn btn-outline-primary" asp-controller="Projects" asp-action="Index">Projects</a>
            <a class="btn btn-success" asp-controller="Projects" asp-action="Create">Create Project</a>
        </div>
    </div>

    <!-- Stats Row (clean cards) -->
    <div class="row mb-4 gx-3">
        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">Total Projects</small>
                <h3 class="mt-2 mb-0">@Model.Projects.Count()</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">Total Issues</small>
                <h3 class="mt-2 mb-0">@(Model.ToDo.Count + Model.InProgress.Count + Model.Done.Count)</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">Open Issues</small>
                <h3 class="mt-2 mb-0">@Model.ToDo.Count()</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">In Progress</small>
                <h3 class="mt-2 mb-0">@Model.InProgress.Count()</h3>
            </div>
        </div>
    </div>

    <!-- Main: Kanban + Recent -->
    <div class="row">
        <!-- Kanban columns -->
        <div class="col-lg-8">
            <div class="row gx-3">
                <div class="col-md-4">
                    <h6 class="fw-semibold">To Do</h6>
                    <div id="todo" class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.ToDo)
                        {
                            <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-id="@issue.Id" data-status="@issue.Status">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="card-title mb-1">@issue.Title</strong>
                                    @await Html.PartialAsync("_StatusTag", issue.Status)
                                </div>
                                <div class="small text-muted mb-2">#@issue.Id</div>
                                <div class="text-muted small">@issue.Description</div>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="fw-semibold">In Progress</h6>
                    <div id="inprogress" class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.InProgress)
                        {
                            <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-id="@issue.Id" data-status="@issue.Status">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="card-title mb-1">@issue.Title</strong>
                                    @await Html.PartialAsync("_StatusTag", issue.Status)
                                </div>
                                <div class="small text-muted mb-2">#@issue.Id</div>
                                <div class="text-muted small">@issue.Description</div>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="fw-semibold">Done</h6>
                    <div id="done" class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.Done)
                        {
                            <div class="kanban-card" draggable="true" ondragstart="drag(event)" data-id="@issue.Id" data-status="@issue.Status">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="card-title mb-1">@issue.Title</strong>
                                    @await Html.PartialAsync("_StatusTag", issue.Status)
                                </div>
                                <div class="small text-muted mb-2">#@issue.Id</div>
                                <div class="text-muted small">@issue.Description</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-lg-4">
            <h6 class="fw-semibold">Recent Activity</h6>
            <div class="list-group">
                @foreach (var a in Model.RecentActivity)
                {
                    <div class="list-group-item mb-2 shadow-sm">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>@a.Title</strong>
                                <div class="small text-muted">Issue #@a.Id</div>
                            </div>
                            <div class="text-end">
                                @await Html.PartialAsync("_StatusTag", a.Status)
                            </div>
                        </div>
                        <div class="mt-2 text-muted small">@a.Description</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Styles (kept compact and aligned with original look) -->
<style>
    /* Stat cards */
    .stat-card {
        background: #fff;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 6px 18px rgba(17,24,39,0.04);
    }

    /* Kanban column */
    .kanban-column {
        min-height: 320px;
        padding: 12px;
        border-radius: 8px;
        background: transparent;
    }

        .kanban-column.dragover {
            outline: 2px dashed rgba(13,110,253,0.25);
            background: rgba(13,110,253,0.02);
        }

    /* Card style (keeps your earlier simple look) */
    .kanban-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 6px 16px rgba(17,24,39,0.04);
        transition: transform .16s ease, box-shadow .16s ease;
    }

        .kanban-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(17,24,39,0.06);
        }

    /* Status tag basic (partial handles colors) */
    .status-tag {
        margin-left: 8px;
    }

    /* Recent activity */
    .list-group-item {
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.04);
        background: #fff;
    }

    /* small responsive tweaks */
    @@media (max-width: 991px) {
        .kanban-column {
            min-height: 220px;
        }
    }

</style>

<!-- Drag/Drop + animate pop for tag -->
<script>
    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('dragover');
    }

    function drag(ev) {
        const card = ev.target.closest('.kanban-card');
        if (!card) return;
        ev.dataTransfer.setData('text/plain', card.getAttribute('data-id'));
    }

    function drop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('dragover');

        const id = ev.dataTransfer.getData('text/plain');
        const card = document.querySelector('.kanban-card[data-id="' + id + '"]');
        if (!card) return;

        // move visually
        ev.currentTarget.appendChild(card);

        // compute new status by column id
        let newStatus = 'Open';
        if (ev.currentTarget.id === 'inprogress') newStatus = 'In Progress';
        if (ev.currentTarget.id === 'done') newStatus = 'Resolved';

        // prepare payload (try to read projectId from data attr if you set it, else fallback 1)
        let projectId = card.getAttribute('data-projectid') || 1;

        // send update to API (assumes PUT /api/issues/{id} accepts full issue)
        fetch(`/api/issues/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: parseInt(id, 10),
                title: card.querySelector('.card-title')?.innerText || card.querySelector('strong').innerText,
                description: card.querySelector('.mt-2')?.innerText || card.querySelector('.text-muted.small')?.innerText || '',
                status: newStatus,
                projectId: parseInt(projectId, 10)
            })
        }).then(resp => {
            if (resp.ok) {
                // animate status tag inside card for feedback
                const tag = card.querySelector('.status-tag');
                if (tag) {
                    tag.classList.remove('pop');
                    void tag.offsetWidth;
                    tag.classList.add('pop');
                    setTimeout(() => tag.classList.remove('pop'), 900);
                }
            } else {
                // revert visual move on failure (simple fallback: reload)
                location.reload();
            }
        }).catch(() => location.reload());
    }

    // remove dragover visual state at dragend
    document.addEventListener('dragend', () => {
        document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('dragover'));
    });
        /* Prevent overlapping footer */
    .recent-activity-container {
        max-height: 75vh;
        overflow-y: auto;
        padding-bottom: 20px;
    }
</script>
