@model MiniJira.MVC.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<div class="container-fluid mt-4">
    <div class="d-flex align-items-center mb-4">
        <!-- logo using your uploaded file path (the system will transform path to URL) -->
        <img src="/mnt/data/31e81f73-b963-495d-b417-8063ff6300d2.png" alt="MiniJira" style="height:48px;margin-right:12px;" />
        <h2 class="m-0">MiniJira — Dashboard</h2>
        <div class="ms-auto">
            <a class="btn btn-outline-primary me-2" asp-controller="Projects" asp-action="Index">Projects</a>
            <a class="btn btn-success" asp-controller="Projects" asp-action="Index">Create Project</a>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-bg-light mb-2">
                <div class="card-body">
                    <h6>Total Projects</h6>
                    <h3>@Model.Projects.Count()</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-light mb-2">
                <div class="card-body">
                    <h6>Total Issues</h6>
                    <h3>@(Model.ToDo.Count + Model.InProgress.Count + Model.Done.Count)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-light mb-2">
                <div class="card-body">
                    <h6>Open</h6>
                    <h3>@Model.ToDo.Count()</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-light mb-2">
                <div class="card-body">
                    <h6>In Progress</h6>
                    <h3>@Model.InProgress.Count()</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Kanban Columns -->
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-4">
                    <h5>To Do</h5>
                    <div id="todo" class="kanban-column p-2 bg-light" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.ToDo)
                        {
                            <div class="card mb-2 kanban-card" draggable="true" ondragstart="drag(event)" data-id="@issue.Id" data-status="@issue.Status">
                                <div class="card-body p-2">
                                    <strong>@issue.Title</strong>
                                    <div class="small text-muted">#@issue.Id</div>
                                    <div class="mt-1">@issue.Description</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <h5>In Progress</h5>
                    <div id="inprogress" class="kanban-column p-2 bg-light" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.InProgress)
                        {
                            <div class="card mb-2 kanban-card" draggable="true" ondragstart="drag(event)" data-id="@issue.Id" data-status="@issue.Status">
                                <div class="card-body p-2">
                                    <strong>@issue.Title</strong>
                                    <div class="small text-muted">#@issue.Id</div>
                                    <div class="mt-1">@issue.Description</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <h5>Done</h5>
                    <div id="done" class="kanban-column p-2 bg-light" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.Done)
                        {
                            <div class="card mb-2 kanban-card" draggable="true" ondragstart="drag(event)" data-id="@issue.Id" data-status="@issue.Status">
                                <div class="card-body p-2">
                                    <strong>@issue.Title</strong>
                                    <div class="small text-muted">#@issue.Id</div>
                                    <div class="mt-1">@issue.Description</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right sidebar: recent activity -->
        <div class="col-md-4">
            <h5>Recent Activity</h5>
            <ul class="list-group">
                @foreach (var a in Model.RecentActivity)
                {
                    <li class="list-group-item">
                        <strong>@a.Title</strong>
                        <div class="small text-muted">Issue #@a.Id — @a.Status</div>
                        <div class="mt-1">@a.Description</div>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<!-- small inline CSS -->
<style>
    .kanban-column { min-height: 300px; border-radius: 6px; }
    .kanban-card { cursor: grab; }
    .kanban-column.dragover { outline: 2px dashed #0d6efd; }
</style>

<!-- small vanilla JS for drag/drop + optimistic update -->
<script>
    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('dragover');
    }

    function drag(ev) {
        ev.dataTransfer.setData("text/plain", ev.target.closest('.kanban-card').getAttribute('data-id'));
    }

    function drop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('dragover');

        const id = ev.dataTransfer.getData("text/plain");
        const card = document.querySelector('.kanban-card[data-id="' + id + '"]');
        if (!card) return;

        // Move card visually
        ev.currentTarget.appendChild(card);

        // Decide new status based on column id
        let newStatus = "Open";
        if (ev.currentTarget.id === "inprogress") newStatus = "In Progress";
        if (ev.currentTarget.id === "done") newStatus = "Resolved";

        // optimistic UI update; send PATCH/PUT to API to update issue status
        fetch(`/api/issues/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: parseInt(id),
                title: card.querySelector('strong').innerText,
                description: card.querySelector('.mt-1').innerText,
                status: newStatus,
                projectId: parseInt(card.querySelector('.small').innerText.replace('#', '')) // fallback
            })
        }).then(resp => {
            if (!resp.ok) {
                alert('Failed to update issue status on server.');
                location.reload();
            }
        }).catch(() => {
            alert('Failed to update issue status on server.');
            location.reload();
        });
    }

    document.addEventListener('dragend', function(e) {
        document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('dragover'));
    });
</script>
