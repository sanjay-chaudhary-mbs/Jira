@model MiniJira.MVC.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<div class="container-fluid mt-4">

    <!-- Header (keeps your original look but centered nicely) -->
    <div class="d-flex align-items-center mb-4">
        <img src="~/Images/PB1.jpg" alt="MiniJira"
             style="height:48px;margin-right:12px;border-radius:50%;
            box-shadow:0 0 4px rgba(0,0,0,0.25);" />



        <h2 class="m-0 fw-semibold">PB - Dashboard</h2>

        <div class="ms-auto d-flex gap-2">
            <a class="btn btn-outline-primary" asp-controller="Projects" asp-action="Index">Projects</a>
            <a class="btn btn-success" asp-controller="Projects" asp-action="Create">Create Project</a>
        </div>
    </div>

    <!-- Stats Row (clean cards) -->
    <div class="row mb-4 gx-3">
        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">Total Projects</small>
                <h3 class="mt-2 mb-0">@Model.Projects.Count()</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">Total Issues</small>
                <h3 class="mt-2 mb-0">@(Model.ToDo.Count + Model.InProgress.Count + Model.Done.Count)</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">Open Issues</small>
                <h3 class="mt-2 mb-0">@Model.ToDo.Count()</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card p-3">
                <small class="text-muted">In Progress</small>
                <h3 class="mt-2 mb-0">@Model.InProgress.Count()</h3>
            </div>
        </div>
    </div>

    <!-- Main: Kanban + Recent -->
    <div class="row">
        <!-- Kanban columns -->
        <div class="col-lg-8">
            <div class="row gx-3">
                <div class="col-md-4">
                    <h6 class="fw-semibold">To Do</h6>
                    <div id="todo" class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.ToDo)
                        {
                            <div class="kanban-card"
                                 draggable="true"
                                 ondragstart="drag(event)"
                                 data-id="@issue.Id"
                                 data-title="@issue.Title"
                                 data-description="@issue.Description"
                                 data-project="@issue.ProjectId"
                                 data-status="@issue.Status">



                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="card-title mb-1">@issue.Title</strong>
                                    @await Html.PartialAsync("_StatusTag", issue.Status)
                                </div>

                                <div class="small text-muted mb-2">#@issue.Id</div>

                                <div class="text-muted small">@issue.Description</div>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="fw-semibold">In Progress</h6>
                    <div id="inprogress" class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.InProgress)
                        {
                            <div class="kanban-card"
                                 draggable="true"
                                 ondragstart="drag(event)"
                                 data-id="@issue.Id"
                                 data-title="@issue.Title"
                                 data-description="@issue.Description"
                                 data-project="@issue.ProjectId"
                                 data-status="@issue.Status">



                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="card-title mb-1">@issue.Title</strong>
                                    @await Html.PartialAsync("_StatusTag", issue.Status)
                                </div>

                                <div class="small text-muted mb-2">#@issue.Id</div>

                                <div class="text-muted small">@issue.Description</div>
                            </div>

                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <h6 class="fw-semibold">Done</h6>
                    <div id="done" class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        @foreach (var issue in Model.Done)
                        {
                            <div class="kanban-card"
                                 draggable="true"
                                 ondragstart="drag(event)"
                                 data-id="@issue.Id"
                                 data-title="@issue.Title"
                                 data-description="@issue.Description"
                                 data-project="@issue.ProjectId"
                                 data-status="@issue.Status">



                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="card-title mb-1">@issue.Title</strong>
                                    @await Html.PartialAsync("_StatusTag", issue.Status)
                                </div>

                                <div class="small text-muted mb-2">#@issue.Id</div>

                                <div class="text-muted small">@issue.Description</div>
                            </div>

                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-lg-4">
            <h6 class="fw-semibold">Recent Activity</h6>
            <div class="list-group">
                @foreach (var a in Model.RecentActivity)
                {
                    <div class="list-group-item mb-2 shadow-sm">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>@a.Title</strong>
                                <div class="small text-muted">Issue #@a.Id</div>
                            </div>
                            <div class="text-end">
                                @await Html.PartialAsync("_StatusTag", a.Status)
                            </div>
                        </div>
                        <div class="mt-2 text-muted small">@a.Description</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card {
        background: #fff;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 6px 18px rgba(17,24,39,0.04);
    }

    .kanban-column {
        min-height: 320px;
        padding: 12px;
        border-radius: 8px;
        background: transparent;
    }

        .kanban-column.dragover {
            outline: 2px dashed rgba(13,110,253,0.25);
            background: rgba(13,110,253,0.02);
        }
    .kanban-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 6px 16px rgba(17,24,39,0.04);
        transition: transform .16s ease, box-shadow .16s ease;
    }

        .kanban-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(17,24,39,0.06);
        }

    .status-tag {
        margin-left: 8px;
    }
    .list-group-item {
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.04);
        background: #fff;
    }

    @@media (max-width: 991px) {
        .kanban-column {
            min-height: 220px;
        }
    }

</style>

<script>
    const API_BASE = "https://localhost:44311"; // <-- API PORT HERE

    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add("dragover");
    }

    function drag(ev) {
        const card = ev.target.closest(".kanban-card");
        ev.dataTransfer.setData("issueId", card.dataset.id);
    }

    function drop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove("dragover");

        let id = ev.dataTransfer.getData("issueId");
        let card = document.querySelector(`[data-id="${id}"]`);

        ev.currentTarget.appendChild(card);

        let newStatus = "Open";
        if (ev.currentTarget.id === "inprogress") newStatus = "In Progress";
        if (ev.currentTarget.id === "done") newStatus = "Done";

        let body = {
            id: parseInt(id),
            title: card.dataset.title,
            description: card.dataset.description,
            status: newStatus,
            projectId: parseInt(card.dataset.project)
        };

        fetch(`${API_BASE}/api/issues/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        })
        .then(res => {
            if (!res.ok) {
                alert("Failed to update. Reloading...");
                location.reload();
            }
        })
        .catch(() => location.reload());
    }

    document.addEventListener("dragend", () => {
        document.querySelectorAll(".kanban-column")
            .forEach(col => col.classList.remove("dragover"));
    });
</script>



